---
import { client } from '../../lib/sanity';

// Step 1 — Get all posts with slugs
export async function getStaticPaths() {
  const posts = await client.fetch(`*[_type == "post" && defined(slug.current)]`);
  return posts.map(post => ({
    params: { slug: post.slug.current },
    props: { post },
  }));
}

// Step 2 — Get current post data
const { post } = Astro.props;
if (!post) return new Response('Post Not Found', { status: 404 });

// Step 3 — Convert Sanity Portable Text into plain paragraphs
function extractTextFromBlocks(blocks = []) {
  return blocks
    .filter(block => block._type === 'block')
    .map(block => {
      const hasChildren = Array.isArray(block.children);
      if (!hasChildren) return '';
      return block.children
        .map(child => child.text || '')
        .join('');
    })
    .filter(text => text.trim() !== '');
}

const paragraphs = extractTextFromBlocks(post.body);
---
<!DOCTYPE html>
<html lang="en">
  <body>
    <main class="article-container">
      <article>
        <section class="post-content">
          <h1>{post.title}</h1>

          {paragraphs.map(text => (
            <p class="body">{text}</p>
          ))}

          <!-- Debug (optional)
          <pre>{JSON.stringify(post, null, 2)}</pre>
          -->
        </section>
      </article>
    </main>
  </body>
</html>
