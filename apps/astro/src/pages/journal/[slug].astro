---
import { client } from '../../lib/sanity';
import Layout from '../../layouts/BlogPost.astro';

// Step 1 — Get all posts with slugs
export async function getStaticPaths() {
  const posts = await client.fetch(`*[_type == "post" && defined(slug.current)]`);
  return posts.map(post => ({
    params: { slug: post.slug.current },
    props: { post },
  }));
}

// Step 2 — Get current post data
const { post } = Astro.props;
if (!post) return new Response('Post Not Found', { status: 404 });

// Step 3 — Convert Sanity Portable Text into plain paragraphs
function extractTextFromBlocks(blocks = []) {
  return blocks
    .filter(block => block._type === 'block')
    .map(block => {
      const hasChildren = Array.isArray(block.children);
      if (!hasChildren) return '';
      return block.children
        .map(child => child.text || '')
        .join('');
    })
    .filter(text => text.trim() !== '');
}

const paragraphs = extractTextFromBlocks(post.body);
---


<Layout
	title={post.title}
	description="Lorem ipsum dolor sit amet"
>
	<article>
    <section class="post-content">
      {paragraphs.map(text => (
        <p class="body">{text}</p>
      ))}

      <!-- Debug (optional)
      <pre>{JSON.stringify(post, null, 2)}</pre>
      -->
    </section>
  </article>
</Layout>
