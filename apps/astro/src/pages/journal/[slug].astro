---
import { client } from '../../lib/sanity';
import Layout from '../../layouts/BlogPost.astro';

export const prerender = false;

// Step 1 — Get current post data
const slugParam = Astro.params.slug;
const slug = typeof slugParam === 'string' ? slugParam : Array.isArray(slugParam) ? slugParam.join('/') : '';

const post = slug
  ? await client.fetch(
      `*[_type == "post" && slug.current == $slug][0]`,
      { slug }
    )
  : null;

if (!post) {
  return new Response('Post Not Found', { status: 404 });
}

// Step 2 — Convert Sanity Portable Text into plain paragraphs
function extractTextFromBlocks(blocks = []) {
  return blocks
    .filter((block) => block._type === 'block')
    .map((block) => {
      const hasChildren = Array.isArray(block.children);
      if (!hasChildren) return '';
      return block.children
        .map((child) => child.text || '')
        .join('');
    })
    .filter((text) => text.trim() !== '');
}

const paragraphs = extractTextFromBlocks(post.body);
---


<Layout
	title={post.title}
	description="Lorem ipsum dolor sit amet"
>
	<article>
    <section class="post-content">
      {paragraphs.map(text => (
        <p class="body">{text}</p>
      ))}

      <!-- Debug (optional)
      <pre>{JSON.stringify(post, null, 2)}</pre>
      -->
    </section>
  </article>
</Layout>
